# 云开发如何处理耗时任务
本文主要向大家分享：如何在云开发技术栈中，处理耗时超长的业务。以及在解决这个问题的过程中，个人的心路历程、以及成长。

## 故事背景
我们团队使用云开发快一年了。在这一年内，公司部分项目使用云开发技术栈来进行开发。当一个新的开发模式、语言、框架开始在技术圈推行的时候，对于开发相关公司、人员，都是一次重大的机遇、挑战。还记得那是2019年春天的一个早上，我成功入了云开发的坑。在后面漫长的开发过程中，有一个“十分嚣张”的问题，困惑了我好几个月，一直没有好的解决方案，那就是“耗时任务”的处理。

## 业务描述
大概是八月份左右，当时有个项目，领导说要在一款“官网小程序”的项目(小程序云开发)上增加一个一键安装模板的功能。

## 实现方案-V1.0
一键安装？嗯，这个业务so ease！让我来实现这个业务，完全就是在浪费我社会三好青年的青春嘛：

1. 创建一个data目录，里面放两个目录：一个命名collection；另外一个命名file。
2. 把集合的数据全导成json文件，文件名就叫集合名，全部丢到collection目录中。
3. 把云存储的文件丢到file目录中。
4. 把data压缩打包，目录结构大致就是下图酱紫，然后上传到云存储。路径:/system/full.zip。
![avatar](https://wx.wegouer.com/static/github/install/p1.png)
5. 到云存储中，复制full.zip外网地址，在云函数中实现一个接口。
	* a.下载full.zip文件到临时目录/tmp/
	* b.解压full.zip文件
	* c.上传/tmp/full/file/目录文件到云存储
	* d.将/temp/full/collection/目录的json文件导入集合，集合名称为json文件名。
6. 在前端加个按钮，点一下自动安装。没毛病，收功。 

## 实现方案-V2.0
### 想我大研发，怎么能做那种手动导出数据、文件这么羞耻的事情呢？不能够啊！遂实现了一个备份系统的接口。

1. 把所有集合名称列出来，写个方法，自动保存。部分代码如下。
![avatar](https://wx.wegouer.com/static/github/install/p2.png)
2. 在保存方法中，读取所有的云存储路径(云存储路径有固定格式cloud://)，对应保存到/tmp/full/file/目录中。
3. 压缩打包成zip，上传到云存储路径/system/full.zip(因为云开发中只能读写/tmp/目录下的文件，并且/temp/目录下的文件可能被清理)。

### 把代码拿到另外一个小程序试试，发现一个超级大的问题。云存储的路径不一样，比如有个云存储地址为(cloud://@@@/img/data.json),这个@@@的值每个小程序不一样。有这个问题我连/system/full.zip文件都获取不到，并且图片等文件显示必然是坏的了。

对于这个问题，实现了一个获取小程序对应云存储绝对路径(cloud://@@@/)的方法。代码大致如下：
![avatar](https://wx.wegouer.com/static/github/install/p3.png)

```
1. 查看内存是否有云存储绝对路径，若有，则返回。
2. 在临时目录/tmp/写一个空文件，我命名为local.txt
3. 将local.txt上传到云存储/system/local.txt路径，此时，上传接口将会返回该文件的详情信息，其中fileID为cloud://@@@/system/local.txt
4. 删除第2步中fileID的/system/local.txt得到fileID绝对路径
5. 保存绝对路径到内存，同时返回结果 
```
对于获取绝对路径这个问题，当时并没有找到太好的解决方案。所以实现了这么个方法，可以在任何小程序中获取当前小程序云存储的路径。我可真是个小机灵鬼。

剩下的就是在安装的时候，用正则替换掉数据文件中的fileID，更改为当前小程序对应云存储的fileID。

## 实现方案-V3.0（本文重点，异常处理方案）
小程序云开发的超时时长，最大只能设置为20秒。当文件、数据比较大时，20秒内完成不了任务。调用“一键安装模板”接口，模板数据多时，至少十分钟。这种情况下一个请求，我们无法获知这个任务的进度，甚至什么时候完成任务都无法知道。在传统服务器架构中，我们一般有两种不同情况下的解决方案：

1. 如果是单服务器，我们可以在服务器后台运行一个任务对象，对外提供一个获取进度、消息、异常的方法。前端轮询请求任务进度，不停的询问这个任务:"你好了没有啊？你进行到哪一步了？你到底行不行啊？"，任务回答前端：“你好烦啊~”。嗯，扯远了。再有一种，就是通过WebSocket由服务器与前端握手后主动向前端推送进度。
2. 如果是分布式架构。一般我们会有个接入层做请求分发。当调用"安装接口"，在其中一个业务服务器上运行任务对象后，可以返回一个接入层能访问的服务器标识。如果前端使用轮询的方式去获取任务进度，每次在"进度获取接口"请求入参中传入"安装接口"返回的标识，接入层便可以通过标识，将请求分发到固定的业务主机实例。以获取到正确的安装进度信息。websocket断线重连也可以通过"业务服务器标识"的方式，重连到正确的主机。

然鹅!!!大家请查看官方文档链接[无状态函数](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/mechanism.html#%E6%97%A0%E7%8A%B6%E6%80%81%E5%87%BD%E6%95%B0)的介绍，里面关于云函数特点的描述：“云函数应是无状态的，幂等的”。啥叫无状态？简单来说两次请求不一定请求到一个主机实例上，两个请求不一定能共享主机内存，只有一个随时可能被回的临时目录。具体与上述服务器方案相比，它木有接入层啊，特殊的请求，无法转发到固定的服务器实例。

那么先调用“安装接口”后，轮询“查询安装进度接口”时，命中的主机实例，不一定是当时执行安装的主机，无法获取它的进度、消息、异常。眼看着领导一句句“你好了没有啊？你进行到哪一步了？你到底行不行啊？”，常人无法理解到我当时焦灼、忐忑、悔恨的心情。还记得那是一个月黑风高的晚上，在万般无奈之下，我想到了一个十分羞耻的解决方案。

1. 调用安装接口，在安装任务启动时生成一个唯一的"任务标识"，返回给前端。
2. 前端轮询时，入参带上"任务标识"。
3. 查询接口被请求时，到当前服务器实例上找是否有安装任务。没有任务或者“任务标识”无法匹配则返回进度查询状态-1，前端不做处理;如果能匹配上则返回进度查询0、安装消息、当前进度、异常等信息。
4. 关于这个方案。如果在安装过程中，没有其它人使用系统，同时在云环境中存在的主机实例预计不超过5台。那么命中机率是1/5，平均每问5次，有一次有回应。5次均没命中的机率为(4^5 )/(5^5 )=32.768%。10次均没命中的机率为(4^10 )/(5^10 )=10.737%。OKOK，对于这个方案，我只能打心里说一句：“15次没命中算我输~”。这个方案总的来说效果还是可以的，调节了一下轮询频率，基本最迟命中时间不超过15秒。

## 实现方案-V4.0(合理方案)
其实在使用V3.0的方案的之前，我就到百度、论坛、社区等等找过，并没有翻到比较有价值的信息。12月初，有一次偶然的机会，领导把这个事情告诉了腾讯云那边的一位大佬。大佬当时就说了:“小伙子，你的问题成功的引起了老夫的注意，来来来，老夫帮你看看。”。然后我们就愉快的聊了起来。。。大致就是下图酱紫：
![avatar](https://wx.wegouer.com/static/github/install/p4.png)
总之就是一顿尬聊，我：“吧拉 吧拉 吧拉”。大佬：“吧拉 吧拉 吧拉”。

最后看到大佬说了一句“可以直接把记录写到数据库中”。顿时，我感觉一切都索然无味了。一直在处理类似的业务上，都是把状态直接放到内存里的。java，开个线程让它去跑，搞个静态变量，用于读取状态。node，构造个类，实例化后放到全局变量下，异步让它自己玩，接口直接返回，过段时间找它要进度。从来没有想过，把这种即时、变动频繁的状态信息写到运行环境之外的地方，供其它业务去读取。没想到啊，没想到。

终级方案：

1. 调用“安装接口”时，启动安装任务，任务状态发生改变时，写入固定的数据库中。
2. 调用“获取安装进度接口”时，获取固定数据库中的记录值，返回给前端显示当前进度。

## 故事总结
### 关于技术
1. 由于云函数无状态的特性，我们在单服务器上的一些开发习惯，比如顺手定个全局变量多次使用，顺手找个地方写文件等与云函数的开发理念不符合。比如文件IO，能不能写、权限够不够另说，只有/tmp/临时目录是同一云环境下所有云函数共享的，并且它还会被不定时的释放清理。
2. 很多业务在云开发技术栈不是不能实现，而是要改变一下思路。比如今天为大家带来的故事。
3. 我个人认为，我们每次学习一种语言、一种框架、一种开发模式，其实最终是学习它的思想、充实自己的业务实现手段。

### 关于个人
我从毕业做开发，已经五年多了。这些年经历过很多次技术换代、框架升级。大多技术在发展的过程中，会有些问题。这次经历我习惯性的认为是技术栈的问题、技术生态或许有缺陷。后面解决后，我发现这并不是一个复杂的问题。为什么我会这么长时间没有去解决，甚至都没有或者说不太愿意和更多的同事、朋友去讨论一下这个事情？现在想来，确实有些飘了。易大师说过：“真正的大师永远都怀着一颗学徒的心”。技术没有止境，我还有很长的路要走。

路漫漫其修远兮，吾将上下而求索。愿与诸君共勉之。
